# Training Data Format Reference

This document describes the format of training data generated by the sokoban-eval-toolkit for SFT (Supervised Fine-Tuning).

## Overview

The toolkit generates training data in a two-phase approach:

1. **Puzzle Generation** - Creates puzzles with programmatic solutions
2. **Solution Generation** - Uses LLMs to generate reasoning traces, then transforms to training format

## Data Pipeline

```
generate-sokoban.ts / generate-nav.ts     generate-solutions*.ts
        |                               |
        v                               v
   train.jsonl  ─────────────>  train_with_reasoning.jsonl
   (puzzles only)               (puzzles + reasoning + solutions)
```

## Response Format

### Training Data Format (SFT Target)

The assistant response in training data uses `<think>` tags for reasoning:

```
<think>
[Step-by-step reasoning here]
</think>

{"solution": "RRDDLUUR"}
```

### Eval Prompt Format

The user prompt instructs the model to produce the above format:

```markdown
## Output Format
First, think through the problem step-by-step inside <think> tags. Then provide your solution as JSON.

<think>
[Your step-by-step reasoning here]
</think>

{"solution": "<moves>"}

Rules:
- Put all reasoning inside the <think> tags
- The solution JSON must come after the </think> tag
- The "solution" field should contain only move characters: U (up), D (down), L (left), R (right)
- Example solution: "RRDDLUUR"

IMPORTANT: Follow this format exactly.
```

## JSONL Entry Structure

### Navigation Puzzles (`type: "navigation"`)

```json
{
  "id": "a1b2c3d4",
  "type": "navigation",
  "width": 6,
  "height": 6,
  "numWalls": 5,
  "pathLength": 8,
  "shortestPath": "RRDDLLUR",
  "puzzle": ["------", "-@----", "--#---", "----G-", "------", "------"],
  "messages": [
    {"role": "system", "content": "..."},
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "<think>...</think>\n\n{\"solution\": \"RRDDLLUR\"}"}
  ]
}
```

### Sokoban Puzzles (`type: "sokoban"`)

```json
{
  "id": "a1b2c3d4",
  "type": "sokoban",
  "puzzle_id": "lmiq_train_6x6_001",
  "difficulty": "easy",
  "puzzle": ["######", "#@$-.#", "#----#", "#--.-#", "#----#", "######"],
  "messages": [
    {"role": "system", "content": "..."},
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "<think>...</think>\n\n{\"solution\": \"RRDDLU\"}"}
  ]
}
```

## Parsing the Response

Use the `parseTrainingResponse` utility to extract reasoning and solution:

```typescript
import { parseTrainingResponse } from '@sokoban-eval-toolkit/utils'

const response = `<think>
First, I observe the player is at row 2...
</think>

{"solution": "RRDDLU"}`

const parsed = parseTrainingResponse(response)
// { reasoning: "First, I observe the player is at row 2...", solution: "RRDDLU" }
```

## Move Notation

Both puzzle types use the same move notation:
- `U` - Up (decrease row)
- `D` - Down (increase row)
- `L` - Left (decrease column)
- `R` - Right (increase column)

## Scripts

| Script | Purpose |
|--------|---------|
| `generate-sokoban.ts` | Generate Sokoban puzzle datasets |
| `generate-nav.ts` | Generate navigation puzzle datasets |
| `generate-solutions.ts` | Generate reasoning traces for Sokoban |
| `generate-solutions-simple.ts` | Generate reasoning traces for navigation |

## Validation

Solutions are validated by replaying the moves:
- Navigation: Player must reach the goal (G)
- Sokoban: All boxes ($) must be on goals (.)

Invalid solutions are marked with `unsolved: true` in the output.
